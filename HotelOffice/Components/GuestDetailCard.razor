@using HotelOffice.Models
@using System.IO

@* الخطوة 1: نستخدم هنا الشرط "is not null" وهو أكثر أمانًا ويفهمه المترجم الحديث *@
@if (GuestData is not null)
{
    <div class="card mb-3" style="max-width: 350px;">
        <div class="card-header text-white bg-dark">
            <strong>معاينة بيانات النزيل</strong>
        </div>

        <img src="@DisplayImageUrl" class="card-img-top" alt="معاينة بطاقة الهوية" style="max-height: 200px; object-fit: cover;" />

        <div class="card-body">
            <h5 class="card-title">@GuestData.FullName</h5>
        </div>
        <ul class="list-group list-group-flush">
            @if (!string.IsNullOrEmpty(GuestData.NationalId))
            {
                <li class="list-group-item"><strong>الرقم القومي:</strong> @GuestData.NationalId</li>
            }
            @if (!string.IsNullOrEmpty(GuestData.PhoneNumber))
            {
                <li class="list-group-item"><strong>رقم الهاتف:</strong> @GuestData.PhoneNumber</li>
            }
        </ul>
    </div>
}

@code {
    [Parameter]
    [EditorRequired]
    public Guest? GuestData { get; set; }

    [Parameter]
    public string? NewImagePreviewUrl { get; set; }

    private string DisplayImageUrl
    {
        get
        {
            if (!string.IsNullOrEmpty(NewImagePreviewUrl))
            {
                return NewImagePreviewUrl;
            }

            // الخطوة 2: نتأكد مرة أخرى هنا قبل الوصول للخصائص
            if (GuestData is not null && !string.IsNullOrEmpty(GuestData.IdCardImageUrl))
            {
                return GetBlazorImageSource(GuestData.IdCardImageUrl);
            }

            return "images/default-id-card.png";
        }
    }

    private string GetBlazorImageSource(string? imagePath)
    {
        if (string.IsNullOrEmpty(imagePath) || !File.Exists(imagePath))
        {
            return "images/default-id-card.png";
        }
        try
        {
            byte[] imageBytes = File.ReadAllBytes(imagePath);
            string base64String = Convert.ToBase64String(imageBytes);
            return $"data:image/png;base64,{base64String}";
        }
        catch (Exception)
        {
            return "images/default-id-card.png";
        }
    }
}