@page "/rooms/add"
@inherits AddRoomBase

<PageTitle>إضافة غرفة جديدة</PageTitle>

<h3>إضافة غرفة جديدة</h3>
<hr />

@if (IsLoading)
{
    <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span class="ms-3"><em>جاري تحميل البيانات الأساسية...</em></span>
    </div>
}
else
{
    <EditForm Model="@newRoom" OnValidSubmit="@HandleAddRoom">
        <DataAnnotationsValidator />

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" role="alert">@errorMessage</div>
        }

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="roomNumber" class="form-label">رقم الغرفة:</label>
                <InputText id="roomNumber" class="form-control" @bind-Value="newRoom.RoomNumber" />
                <ValidationMessage For="@(() => newRoom.RoomNumber)" />
            </div>
            <div class="col-md-6 mb-3">
                <label for="price" class="form-label">السعر لليلة:</label>
                <InputNumber id="price" class="form-control" @bind-Value="newRoom.PricePerNight" />
                <ValidationMessage For="@(() => newRoom.PricePerNight)" />
            </div>
            <div class="col-md-6 mb-3">
                <label for="floor" class="form-label">الطابق:</label>
                <InputSelect id="floor" class="form-select" @bind-Value="newRoom.FloorId">
                    <option value="0" disabled>-- اختر طابق --</option>
                    @foreach (var floor in floors)
                    {
                        <option value="@floor.Id">@floor.Name</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => newRoom.FloorId)" />
            </div>
            <div class="col-md-6 mb-3">
                <label for="roomType" class="form-label">نوع الغرفة:</label>
                <InputSelect id="roomType" class="form-select" @bind-Value="newRoom.RoomTypeId">
                    <option value="0" disabled>-- اختر نوع الغرفة --</option>
                    @foreach (var type in roomTypes)
                    {
                        <option value="@type.Id">@type.Name</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => newRoom.RoomTypeId)" />
            </div>
            <div class="col-md-6 mb-3">
                <label for="capacity" class="form-label">عدد الأشخاص:</label>
                <InputNumber id="capacity" class="form-control" @bind-Value="newRoom.Capacity" />
                <ValidationMessage For="@(() => newRoom.Capacity)" />
            </div>
            <div class="col-md-6 mb-3">
                <label for="beds" class="form-label">عدد الأسرّة:</label>
                <InputNumber id="beds" class="form-control" @bind-Value="newRoom.NumberOfBeds" />
                <ValidationMessage For="@(() => newRoom.NumberOfBeds)" />
            </div>
            <div class="col-12 mb-3">
                <label for="description" class="form-label">الوصف:</label>
                <InputTextArea id="description" class="form-control" @bind-Value="newRoom.Description" rows="3" />
            </div>
        </div>

        <hr />
        <h5 class="mb-3">المرافق المتوفرة</h5>

        <!-- ✅ --- التصميم الجديد والآمن للمرافق --- ✅ -->
        <div class="mb-3 p-3 border rounded bg-light">
            @if (!selectedAmenityIds.Any())
            {
                <p class="text-muted mb-0"><em>لم يتم اختيار أي مرافق. انقر على الزر لإضافة مرافق.</em></p>
            }
            else
            {
                <ul class="list-inline mb-0">
                    @foreach (var amenityId in selectedAmenityIds)
                    {
                        var amenity = allAmenities?.FirstOrDefault(a => a.Id == amenityId);
                        if (amenity != null)
                        {
                            <li class="list-inline-item mb-1">
                                <span class="badge bg-secondary">@amenity.Name</span>
                            </li>
                        }
                    }
                </ul>
            }
            <button type="button" class="btn btn-outline-primary btn-sm mt-2" @onclick="OpenAmenitiesModal">
                <span class="bi bi-pencil-square me-1"></span> إدارة المرافق
            </button>
        </div>

        <hr />
        <h5 class="mb-3">صورة الغرفة</h5>
        <div class="row align-items-center">
            <div class="col-md-6 mb-3">
                <InputFile id="imageUpload" class="form-control" OnChange="HandleImageUpload" />
            </div>

            @if (!string.IsNullOrEmpty(imageDataUrl))
            {
                <div class="col-md-6 mb-3">
                    <div class="text-center">
                        <img src="@imageDataUrl" class="rounded border" style="max-width: 200px; max-height: 150px; object-fit: cover;" alt="معاينة الصورة" />
                    </div>
                </div>
            }
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary" disabled="@isSaving">
                @if (isSaving)
                {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span> جاري الحفظ...</span>
                }
                else
                {
                    <span class="bi bi-check-circle-fill me-1"></span>
                    <span>حفظ الغرفة</span>
                }
            </button>
            <button type="button" class="btn btn-secondary" @onclick="Cancel">
                <span class="bi bi-x-circle me-1"></span>
                <span>إلغاء</span>
            </button>
        </div>
    </EditForm>
}

<!-- ✅ --- النافذة المنبثقة لاختيار المرافق --- ✅ -->
@if (IsAmenitiesModalOpen)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show" style="display:block" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">اختر المرافق</h5>
                    <button type="button" class="btn-close" @onclick="CloseAmenitiesModal"></button>
                </div>
                <div class="modal-body">
                    @if (allAmenities == null || !allAmenities.Any())
                    {
                        <p>لا توجد مرافق متاحة. يرجى إضافتها من شاشة "إدارة المرافق" أولاً.</p>
                    }
                    else
                    {
                        <div class="list-group">
                            @foreach (var amenity in allAmenities)
                            {
                                <label class="list-group-item d-flex align-items-center">
                                    <input class="form-check-input me-3"
                                           type="checkbox"
                                           checked="@selectedAmenityIds.Contains(amenity.Id)"
                                           @onchange="() => ToggleAmenitySelection(amenity.Id)" />
                                    @amenity.Name
                                </label>
                            }
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" @onclick="CloseAmenitiesModal">
                        <span class="bi bi-check-lg me-1"></span>
                        تم
                    </button>
                </div>
            </div>
        </div>
    </div>
}